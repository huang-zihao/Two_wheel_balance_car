# 一、平衡原理

车以一定速度、加速度往倾斜方向驶去

# 二、器材、开发软件的使用

最重要的两个器材，MPU5060，电机驱动模块

## MPU5060（姿态检测：3轴加速度传感器+3轴角速度传感器

1.mpu6050是采用的I2C通信，需要将开发板BOOT1和BOOT0置于0
2.需要进行滤波操作，在z轴加速度上误差特别大

![image](https://user-images.githubusercontent.com/109507018/180629533-ad665100-ab85-4ac0-877a-4f38ea61dc0e.png)

可以通过简单均值滤波处理一下，即将开始读取的一部分数据进行平均，再于获取函数中减去（注意在z轴加速度需要补回，因为一开始是打算z轴朝上进行稳定值得读取）


## AB向无刷直流电机
AB向编码器：

![image](https://user-images.githubusercontent.com/109507018/180652436-93de5264-e845-45ea-97a9-416221dedffb.png)


旋转方向：A上升沿，B低电平————顺时针转    A下降沿，B高电平————一次顺时针转结束
          
A上升沿，B高电平————逆时针转    A下降沿，B低电平————一次逆时针转结束
          
即顺转（10——01），逆转（11——00）。

计数方式，如果是顺转————计A上升沿个数

无刷直流驱动方式：
直接pwm输入即可
但是需要驱动、稳压（至5V）
烧坏了一个TB6612（只接VCC、GND就冒烟了，排除电源接反，好像是PWM口之前接高电平，可能是？）
买了另一个TB6612

另外，蓝牙模块因为自己板子画不好，寄了
## 开发软件&调试工具
 STM32CubeMx、Keil5、Xcom、立创EDA
 
# 三、算法
PID控制算法

控制的想法就是：
向着倾斜的方向行驶，直至直立。
PID中只需要用PD，因为这里不考虑倾斜角的精确，只想快速稳定，那么e就是角度差，ec就是角度速度变化率（角速度），直立环就好了。
平衡车为什么只有角度环不够，还需要速度环：
因为当角度环有偏差的时候，根据角度环的pid是可以给小车输出pwm波维持小车平衡的，但是小车要以什么样的速度维持平衡角度环是做不到的，加上速度环的目的就是于此。
直立环PD：Kp*(角度-期望角度)+Kd*(角速度-0)
速度环PI: Kp*(速度-期望速度)+Ki*位移
转向环PD: 就输出两个方向相反的就行了

## 直立环：
作用：维持直立平衡
设想：参考钟摆逐渐停下的过程1.偏差越大，加速度越大，下一刻速度越大  2.运动速度越大，阻力越大，下一刻速度越小
给一个倾斜，Kp、Kd作用，当倾斜不在增大，Kp作用，当要扶正角度，倾斜角速度反方向增大，此时Kp - Kd的作用，Kd类似阻尼
## 速度环：

往往，我们只使用直立环，小车只能短暂的平衡几秒，然后就朝着一个方向倒去了。
只有直立环的平衡小车会倒下的原因：没有对小车平移速度没有限制，这样就可能超过PWM的幅值，导致电机无法加速了，也就没有了有效的回复力，所以小车就倒了。

作用：在小车平衡的同时，尽量让小车车身保持静止，就是小车车身速度为零，也就是对小车平移速度进行限制
设想：既然在一顿平衡操作之后，我们得到的是一个带有直立环的小车系统，既然还有小车速度需要控制，那就再加一个速度控制器PI，考虑现实中有一定阻力不用微分。

# 四、设计

![image](https://user-images.githubusercontent.com/109507018/187631253-2a7e8a85-050a-4e41-8762-d88e74cf3c96.png)

![image](https://user-images.githubusercontent.com/109507018/187633670-7a69e9a9-90d4-4524-81f5-0afc7a268bff.png)

![IMG_20220831_163029_edit_162348513123663](https://user-images.githubusercontent.com/109507018/187633386-76a99ff8-c89a-4ec4-bcae-a63905dbeab0.jpg)

![image](https://user-images.githubusercontent.com/109507018/187633847-ceb8eecc-eedb-415b-8dd5-7fbc61973e18.png)

功能：直立、OLED开机显示提示

五、代码、参数整理调节
调参：根据实践发现，只靠直立环是能在中小干扰下保持静止的，其中Kp越大，振幅越大，响应越快。
          10（响应小）--30（大幅震荡），暂取30；
          Kd：1（大幅震荡）--30（震荡消失）；
          给予大幅干扰，跑飞————原因，响应太慢
          增大Kp至100（大幅震荡）--50（震荡消失）--干扰--无跑飞
          
          加入速度环（由于电机又一边的霍尔传感器有点问题，也可能是本身程序计数问题，误差很大，滤波也没用，不考虑积分）
          Kp：1（高频震荡）--0.5（停下时较明显震荡）
          直立环kd：24（震荡现象不明显）
          
# 六、总结
          吐槽：弱鸡，没办法，除了keil5，这些开发工具都是第一次用，板子打错了不少，最后本来想通过蓝牙上位机控制的，奈何先是忘了模块设置的波特率（不是9600也不是38600）要重置，然后是按照一些帖子和视频上的操作一点点来的，用HAL的来获取串口信息，它就是获取不了，模块也没坏，就几行代码，几个配置，帖子的可以，我的不行，但是遇到的问题比较晚，没时间解决了，甘，我还以为不是问题，之前用库函数写的没问题。其次，速度环的本质，就输出一期望角度呗，企图让车身达到一定速度。
